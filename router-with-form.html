<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>EU Research Experiment – Router</title>
  <style>
    /* --- Reset & base --- */
    *, *::before, *::after { box-sizing: border-box; }
    html, body { height: 100%; }
    body {
      margin: 0;
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, "Apple Color Emoji", "Segoe UI Emoji";
      color: #0f172a; /* slate-900 */
      background: radial-gradient(1200px 800px at 20% 10%, #e0f2fe 0%, transparent 60%),
                  radial-gradient(1000px 700px at 80% 20%, #fae8ff 0%, transparent 60%),
                  linear-gradient(180deg, #f8fafc 0%, #eef2ff 100%);
    }

    a { color: #4f46e5; text-decoration: none; }
    a:hover { text-decoration: underline; }

    /* --- Layout --- */
    .wrap {
      min-height: 100%;
      display: grid;
      place-items: center;
      padding: 2rem 1rem;
    }

    .card {
      width: 100%;
      max-width: 860px;
      background: rgba(255, 255, 255, 0.85);
      backdrop-filter: blur(8px);
      border-radius: 1.25rem; /* rounded-2xl */
      box-shadow: 0 20px 35px rgba(30, 41, 59, 0.15);
      border: 1px solid rgba(148, 163, 184, 0.25);
      overflow: hidden;
    }

    .card__header {
      padding: 1.25rem 1.5rem;
      background: linear-gradient(90deg, #6366f1, #8b5cf6, #06b6d4);
      color: white;
    }
    .title { margin: 0; font-weight: 800; letter-spacing: 0.2px; }
    .subtitle { margin: 0.25rem 0 0; opacity: 0.95; font-weight: 500; }

    .card__body { padding: 1.5rem; }
    .grid { display: grid; gap: 1rem; }
    @media (min-width: 768px) { .grid-cols-2 { grid-template-columns: repeat(2, minmax(0, 1fr)); } }

    /* --- Form controls --- */
    label { display: block; font-weight: 700; margin-bottom: 0.5rem; }
    .hint { color: #334155; font-size: 0.9rem; margin-top: 0.35rem; }

    .select,
    .button,
    .input {
      width: 100%;
      border-radius: 0.9rem;
      border: 1px solid #c7d2fe; /* indigo-200 */
      background: #ffffff;
      padding: 0.9rem 1rem;
      font-size: 1rem;
      outline: none;
      transition: box-shadow 160ms ease, border-color 160ms ease, transform 90ms ease;
    }
    .select:focus,
    .input:focus {
      border-color: #7c3aed; /* violet-600 */
      box-shadow: 0 0 0 6px rgba(124, 58, 237, 0.12);
    }

    .button {
      font-weight: 800;
      color: white;
      background: linear-gradient(135deg, #4f46e5, #7c3aed);
      border: none;
      cursor: pointer;
    }
    .button:hover { filter: brightness(1.05); transform: translateY(-1px); }
    .button:active { transform: translateY(0); }
    .button--ghost { background: transparent; color: #4f46e5; border: 2px dashed #a5b4fc; }
    .button--muted { background: #e2e8f0; color: #111827; }

    .pill {
      display: inline-flex; align-items: center; gap: 0.4rem;
      font-size: 0.85rem; font-weight: 700;
      padding: 0.35rem 0.75rem; border-radius: 999px;
      background: #eef2ff; color: #3730a3; border: 1px solid #c7d2fe;
    }

    .stage {
      display: none;
      animation: fadeIn 240ms ease;
    }
    .stage.active { display: block; }

    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(6px); }
      to   { opacity: 1; transform: translateY(0); }
    }

    .notice {
      border: 1px solid #fecaca; /* red-200 */
      background: #fff1f2; /* rose-50 */
      color: #7f1d1d; /* red-900 */
      padding: 0.9rem 1rem;
      border-radius: 0.75rem;
    }

    .success {
      border: 1px solid #bbf7d0; /* green-200 */
      background: #ecfdf5; /* emerald-50 */
      color: #064e3b; /* emerald-900 */
      padding: 0.9rem 1rem;
      border-radius: 0.75rem;
    }

    .footer {
      padding: 1rem 1.5rem 1.25rem;
      display: flex; justify-content: space-between; align-items: center;
      border-top: 1px dashed #e5e7eb;
      color: #475569; font-size: 0.92rem;
    }
  </style>
</head>
<body>
  <div class="wrap">
    <main class="card" role="main" aria-labelledby="appTitle">
      <header class="card__header">
        <h1 id="appTitle" class="title">Experiment Router</h1>
        <p class="subtitle"></p>
      </header>

      <section class="card__body">
        <!-- Stage 1: MTurk ID + Country -->
        <div id="stage1" class="stage active" aria-live="polite">
          <div class="grid grid-cols-2">
            <div>
              <label for="mturkId">Step 1 — Enter your MTurk ID</label>
              <input id="mturkId" class="input" type="text" placeholder="e.g., A123BCD4567" autocomplete="off" />
              <div class="notice" style="margin-top:0.75rem;">
                <strong>Participate only once.</strong> Any duplicate ID will not receive any form of payment.
              </div>
            </div>
            <div>
              <label for="country">Select your country of residence</label>
              <select id="country" class="select" required>
                <option value="" selected>— Select your country —</option>
                <!-- NOTE: List provided by the user. Added Israel and Kazakhstan to match region definitions. -->
                <option>Albania</option>
                <option>Andorra</option>
                <option>Armenia</option>
                <option>Austria</option>
                <option>Azerbaijan</option>
                <option>Belarus</option>
                <option>Belgium</option>
                <option>Bosnia and Herzegovina</option>
                <option>Bulgaria</option>
                <option>Croatia</option>
                <option>Cyprus</option>
                <option>Czechia (Czech Republic)</option>
                <option>Denmark</option>
                <option>Estonia</option>
                <option>Finland</option>
                <option>France</option>
                <option>Georgia</option>
                <option>Germany</option>
                <option>Greece</option>
                <option>Hungary</option>
                <option>Iceland</option>
                <option>Ireland</option>
                <option>Israel</option><!-- added for Latin region -->
                <option>Italy</option>
                <option>Kazakhstan</option><!-- added for Eastern region -->
                <option>Kosovo</option>
                <option>Latvia</option>
                <option>Liechtenstein</option>
                <option>Lithuania</option>
                <option>Luxembourg</option>
                <option>Malta</option>
                <option>Moldova</option>
                <option>Monaco</option>
                <option>Montenegro</option>
                <option>Netherlands</option>
                <option>North Macedonia</option>
                <option>Norway</option>
                <option>Poland</option>
                <option>Portugal</option>
                <option>Romania</option>
                <option>Russia</option>
                <option>San Marino</option>
                <option>Serbia</option>
                <option>Slovakia</option>
                <option>Slovenia</option>
                <option>Spain</option>
                <option>Sweden</option>
                <option>Switzerland</option>
                <option>Turkey</option>
                <option>Ukraine</option>
                <option>United Kingdom</option>
                <option>Vatican City</option>
              </select>
              <p class="hint">This will route you to the appropriate regional experiment.</p>
            </div>
          </div>

          <div class="grid" style="margin-top:1rem;">
            <div>
              <label for="consent">Participation confirmation</label>
              <div class="success">
                By continuing, I confirm that I am eligible to participate and consent to proceed to the experiment routing step.
              </div>
            </div>
          </div>

          <div style="margin-top:1rem; display:flex; gap:0.75rem;">
            <button id="continueBtn" class="button" type="button">Continue</button>
            <!-- Reset button removed per request -->
          </div>
          <div id="screeningMsg" class="hint" style="margin-top:0.75rem;"></div>
        </div>

        <!-- Stage 2: Region router & random assigner -->
        <div id="stage2" class="stage" aria-live="polite">
          <div style="display:flex; align-items:center; justify-content:space-between; gap:1rem; margin-bottom:0.5rem;">
            <span class="pill" id="regionPill">Region</span>
            <button class="button button--muted" type="button" id="backBtn">← Go back</button>
          </div>
          <h2 style="margin:0 0 0.25rem 0; font-size:1.5rem; font-weight:900;">Step 2 — Select an experiment</h2>
          <p class="hint" style="margin-bottom:1rem;">Click the button below to be assigned to an experiment.</p>

          <div class="grid grid-cols-2" style="align-items:flex-start;">
            <div>
              <button id="assignBtn" class="button" type="button">Select an experiment</button>
              <div id="assignMsg" class="hint" style="margin-top:0.75rem;"></div>
            </div>
            <div></div>
          </div>
        </div>

        <!-- Stage: Ineligible notice -->
        <div id="stageIneligible" class="stage" aria-live="polite">
          <div class="notice">
            <strong>I'm sorry, you cannot participate in this experiment.</strong>
            <div class="hint" style="margin-top:0.5rem;">Your selected country is not part of the eligible regions for this study.</div>
          </div>
          <div style="margin-top:0.75rem;"><button class="button button--muted" type="button" id="restartBtn">Start over</button></div>
        </div>
      </section>

      <div class="footer">
        <div></div>
        <div></div>
      </div>
    </main>
  </div>

  <script>
    // --------------------------
    // Configuration (EDIT THESE)
    // --------------------------
    const EXPERIMENT_LINKS = {
      EASTERN: [
        "https://ai-noise1-pattern-4daac5ed8a4a.herokuapp.com/join/sumatato",
        "https://ai-seasonal2-pattern-9479056a4df3.herokuapp.com/join/fupahiri",
        "https://ais-m-pattern-a95f6c31c118.herokuapp.com/join/nivenuze",
        "https://trad-noise1-pattern-471105a241fc.herokuapp.com/join/kekivojo",
        "https://trad-seasonal3-pattern-2cea616568d4.herokuapp.com/join/midilote",
        "https://trad-sim-patter-e5e6f91aef2e.herokuapp.com/join/lugobepe"
      ],
      NORTHERN_GERMANIC: [
        "https://ai-noise1-pattern-4daac5ed8a4a.herokuapp.com/join/jaleraru",
        "https://ai-seasonal2-pattern-9479056a4df3.herokuapp.com/join/tareravo",
        "https://ais-m-pattern-a95f6c31c118.herokuapp.com/join/jelovoho",
        "https://trad-noise1-pattern-471105a241fc.herokuapp.com/join/fonakema",
        "https://trad-seasonal3-pattern-2cea616568d4.herokuapp.com/join/tupufedu",
        "https://trad-sim-patter-e5e6f91aef2e.herokuapp.com/join/zetuteji"
      ],
      LATIN: [
        "https://ai-noise1-pattern-4daac5ed8a4a.herokuapp.com/join/fijodubi",
        "https://ai-seasonal2-pattern-9479056a4df3.herokuapp.com/join/tufuguko",
        "https://ais-m-pattern-a95f6c31c118.herokuapp.com/join/jamaviju",
        "https://trad-noise1-pattern-471105a241fc.herokuapp.com/join/dekijano",
        "https://trad-seasonal3-pattern-2cea616568d4.herokuapp.com/join/rakojoze",
        "https://trad-sim-patter-e5e6f91aef2e.herokuapp.com/join/bazakute"
      ]
    };

    // --------------------------
    // Country → Region mapping
    // --------------------------
    const REGIONS = {
      EASTERN: "Eastern Europe",
      NORTHERN_GERMANIC: "Northern & Germanic Europe",
      LATIN: "Latin Europe"
    };

    const EASTERN_COUNTRIES = new Set([
      "Hungary", "Russia", "Kazakhstan", "Albania", "Poland", "Greece", "Slovenia", "Czechia (Czech Republic)", "Georgia"
    ]);

    const NORTHERN_GERMANIC_COUNTRIES = new Set([
      "Denmark", "Finland", "Sweden", "Latvia", "Germany", "Austria", "Netherlands", "Switzerland", "Belgium"
    ]);

    const LATIN_COUNTRIES = new Set([
      "Israel", "Italy", "Portugal", "Spain", "France"
    ]);

    function normalizeCountry(name) {
      if (!name) return "";
      const n = String(name).trim();
      const map = new Map([
        ["Czech Republic", "Czechia (Czech Republic)"],
        ["the Netherlands", "Netherlands"],
        ["UK", "United Kingdom"],
      ]);
      return map.get(n) || n;
    }

    function countryToRegion(country) {
      const c = normalizeCountry(country);
      if (EASTERN_COUNTRIES.has(c)) return "EASTERN";
      if (NORTHERN_GERMANIC_COUNTRIES.has(c)) return "NORTHERN_GERMANIC";
      if (LATIN_COUNTRIES.has(c)) return "LATIN";
      return null;
    }

    // --------------------------
    // Secure uniform RNG helpers
    // --------------------------
    function randomInt(maxExclusive) {
      if (window.crypto && window.crypto.getRandomValues) {
        const arr = new Uint32Array(1);
        window.crypto.getRandomValues(arr);
        return arr[0] % maxExclusive;
      }
      return Math.floor(Math.random() * maxExclusive);
    }

    function pickExperimentLink(regionKey) {
      const arr = EXPERIMENT_LINKS[regionKey] || [];
      if (!arr.length || arr.some(x => typeof x !== 'string')) return { ok: false, reason: 'not_configured' };
      const filled = arr.filter(Boolean);
      if (filled.length < 6) return { ok: false, reason: 'missing_links' };
      const idx = randomInt(6);
      return { ok: true, idx, url: filled[idx] };
    }

    // --------------------------
    // UI logic
    // --------------------------
    const stage1 = document.getElementById('stage1');
    const stage2 = document.getElementById('stage2');
    const stageIneligible = document.getElementById('stageIneligible');

    const mturkInput = document.getElementById('mturkId');
    const countrySel = document.getElementById('country');
    const continueBtn = document.getElementById('continueBtn');
    const screeningMsg = document.getElementById('screeningMsg');

    const assignBtn = document.getElementById('assignBtn');
    const assignMsg = document.getElementById('assignMsg');
    const regionPill = document.getElementById('regionPill');
    const backBtn = document.getElementById('backBtn');
    const restartBtn = document.getElementById('restartBtn');

    let activeRegionKey = null;

    function show(el) { el.classList.add('active'); }
    function hide(el) { el.classList.remove('active'); }

    function gotoStage(stage) {
      hide(stage1); hide(stage2); hide(stageIneligible);
      if (stage === 1) show(stage1);
      if (stage === 2) show(stage2);
      if (stage === 'ineligible') show(stageIneligible);
    }

    function setRegionUI(regionKey) {
      activeRegionKey = regionKey;
      regionPill.textContent = REGIONS[regionKey] || 'Region';
      assignMsg.textContent = '';
    }

    // Simple MTurk ID sanity check: non-empty & alphanumeric-ish
    function isValidMTurkId(v) {
      if (!v) return false;
      const s = String(v).trim();
      return /^[A-Za-z0-9_-]{4,}$/.test(s);
    }

    continueBtn.addEventListener('click', () => {
      const mturkId = mturkInput.value.trim();
      const c = countrySel.value;

      if (!isValidMTurkId(mturkId) && !c) {
        screeningMsg.textContent = 'Please enter a valid MTurk ID and select your country to continue.';
        return;
      }
      if (!isValidMTurkId(mturkId)) {
        screeningMsg.textContent = 'Please enter a valid MTurk ID (letters/numbers, at least 4 characters).';
        mturkInput.focus();
        return;
      }
      if (!c) {
        screeningMsg.textContent = 'Please select your country to continue.';
        countrySel.focus();
        return;
      }

      // Persist locally for step 2
      sessionStorage.setItem('mturk_id', mturkId);
      sessionStorage.setItem('country', c);

      const regionKey = countryToRegion(c);
      if (!regionKey) {
        gotoStage('ineligible');
        return;
      }
      setRegionUI(regionKey);
      gotoStage(2);
      screeningMsg.textContent = '';
    });

    backBtn.addEventListener('click', () => {
      gotoStage(1);
    });

    restartBtn?.addEventListener('click', () => {
      sessionStorage.removeItem('mturk_id');
      sessionStorage.removeItem('country');
      mturkInput.value = '';
      countrySel.value = '';
      screeningMsg.textContent = '';
      gotoStage(1);
    });

    assignBtn.addEventListener('click', () => {
      if (!activeRegionKey) return;

      const pick = pickExperimentLink(activeRegionKey);
      if (!pick.ok) {
        if (pick.reason === 'not_configured') {
          assignMsg.innerHTML = '⚠️ <strong>Setup needed:</strong> Please fill in <code>EXPERIMENT_LINKS.' + activeRegionKey + '</code> with six full URLs.';
        } else if (pick.reason === 'missing_links') {
          assignMsg.innerHTML = '⚠️ <strong>Setup needed:</strong> One or more experiment links are empty. Please complete all six URLs for this region before use.';
        }
        return;
      }

      // Pull details saved from step 1
      const mturkId = sessionStorage.getItem('mturk_id') || '';
      const country = sessionStorage.getItem('country') || '';

      assignMsg.textContent = 'Assigning you now…';

      setTimeout(() => {
        try {
          const url = new URL(pick.url);
          if (mturkId) url.searchParams.set('mturk_id', mturkId);
          if (country) url.searchParams.set('country', country);
          url.searchParams.set('region', activeRegionKey);
          // optional: which of the six links was chosen (0..5)
          url.searchParams.set('arm', String(pick.idx));
          window.location.href = url.toString();
        } catch (e) {
          // Fallback if URL constructor fails (shouldn't on valid URLs)
          const qp = new URLSearchParams({
            mturk_id: mturkId,
            country: country,
            region: activeRegionKey,
            arm: String(pick.idx)
          }).toString();
          const sep = pick.url.includes('?') ? '&' : '?';
          window.location.href = pick.url + sep + qp;
        }
      }, 400);
    });

    // Restore saved values (nice UX)
    const savedId = sessionStorage.getItem('mturk_id');
    const savedC = sessionStorage.getItem('country');
    if (savedId) mturkInput.value = savedId;
    if (savedC) countrySel.value = savedC;
  </script>
</body>
</html>
